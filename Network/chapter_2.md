# TCP/IP、プロトコルスタックが依頼を受けた際の実際の動き

* プロトコル・スタック... OSに組み込まれたネットワーク制御用ソフトウェア<br>

ブラウザから依頼を受けたプロトコル・スタックが TCPプロトコル を用いてメッセージを送受信する4つのフェーズ

1. ソケットを作成する
2. サーバーに接続する
3. データを送受信する
4. サーバーから切断してソケットを抹消

* LANアダプタ... ネットワーク用のハードウェア

## ソケットを作成する

### プロトコル・スタックの内部構成

データ送受信の依頼のおおまかな階層構造<br>

ネットワーク・アプリケーション(ブラウザ、Webサーバー、メーラー、メールサーバー)... ここから下に向けてデータの送受信などの仕事を依頼する<br>

↓<br>

Socketライブラリ(リゾルバ)... DNSサーバーに問い合わせる動作を実行<br> 

↓<br>

プロトコル・スタック(OS内部)<br>

プロトコル・スタックの上部には、「TCP」というプロトコルを使ってデータを送受信する部分と、「UDP」というプロトコルを使ってデータを送受信する部分があり、この2つがアプリケーションからの依頼を受けて送受信動作を実行する<br>

TCP... ブラウザやメールなどの通常のアプリケーションが送受信する場合に使う<br>
UDP... DNSサーバーへの問い合わせなどで短い制御用のデータを送受信する場合に使う<br>

その下に「IP」というプロトコルを使ってパケット送受信動作をコントロールをする部分がある。<br>

IP... インターネットでデータを運ぶ時は、データを小分けにして パケット という形で運ぶが、そのパケットを通信相手まで運ぶのがIPの主な役割で、IPの中には「ICMP」とか「ARP」というプロトコルを扱う部分がある。<br>

ICMP... パケットを運ぶ時に発生するエラーを通知したり、制御用のメッセージを通知する時に使う<br>
ARP(アープ)... IPアドレスに対応するイーセネットのMACアドレスを調べる時に使う

↓<br>

LANドライバ... LANアダプタのハードウェアをコントロールするもので、下にあるLANアダプタが実際の送受動作、つまりケーブルに対して信号を送受信する動作を実行する<br>

↓<br>

LANアダプタ

### ソケットの実態

ソケットの実態は通信制御用の制御情報または、制御情報を記録したメモリー領域<br>
→プロトコル・スタックは内部に制御情報を記録するメモリー領域を持ち、そこに通信動作を制御するための制御情報を記録する<br>
例:通信相手のIPアドレス、ポート番号、通信動作がどのような進行状態か<br>

プロトコルスタックはこの制御情報(ソケット)を参照しながら、動作する<br>

例:データ送信時に相手側のIPアドレスやポート番号を見て、データを送信する<br>
   データ送信をした後の、返事があるのかや送信動作後の経過時間を見て、送り直しを動作が必要か判断する<br>

### socketを呼び出した時の動き

<TCP担当部分>

ブラウザが「socket」を呼び出してソケットを作るように依頼してきたら、プロトコル・スタックは依頼に従いソケットを1つ作成する。<br>

作成の流れ<br>

1. プロトコル・スタックが最初に行うことは、ソケット1つ分のメモリー領域を確保し、そこに中身に相当する制御情報を記録する<br>
   (この時点では、ソケットは作成直後で、まだ送受信動作が始まっていない初期状態のため、初期状態であることを表す制御情報をメモリーに記録する)<br>
   →これで、ソケットが出来上がったことになる。

2. プロトコル・スタックはそのソケットを示すディスクリプタをブラウザに知らせる。
   →以後ブラウザはプロトコル・スタックにデータの送受信動作を依頼する時に、ディスクリプタを通知する<br>
   (ディスクリプタが分かれば、どのソケットかが分かるので、プロトコル・スタックはそのソケットを見て通信相手の必要な情報が分かる)

## サーバーに接続する

### 接続するとは

ソケットを作成したら、ブラウザは「connect」を呼びだして、自分のソケットをサーバー側に接続する<br>

接続するとは...通信相手との間で制御情報をやり取りして、ソケットに必要な情報を記録し、データを送受信可能な状態にする<br>

制御情報... IPアドレスやポート番号などのデータ送受信動作をコントロールするための情報<br>

接続動作の役割<br>

* 通信相手(サーバー)の情報をプロトコル・スタックに知らせる

クライアント側がソケットを作成した直後はまだ何も記録されていないので、通信相手もわからず、送信依頼が来てもどこにデータを送ったらいいのか分からない。<br>
ブラウザはIPアドレスを知っているし、ポート番号はルールで決まっているので(HTTP 80番)、その情報をプロトコル・スタックに知らせる

* クライアント側からサーバー側に通信相手に通信動作の開始を伝える
サーバー側もソケットを作成するだけでは通信相手はわからず、サーバー側のアプリも通信相手がわからない。<br>
→クライアント側からIPアドレスやポート番号などの情報を知らせて、通信したいということをサーバー側に伝えることで、サーバー側のプロトコル・スタックもクライアントの情報を持つことができる。

* バッファメモリーの確保
データの送受信動作を実行する時は、送受信するデータを一時的に格納するメモリー領域が必要。<br>
このメモリー領域をバッファ・メモリーと呼び、その確保も接続動作の時に実行する。

### 先頭部分に制御情報を記載したヘッダーを配置する

制御情報には大きく下記の2種類ある<br>

1. クライアントとサーバーが互いに連絡を取り合うためにやり取りする制御情報(ヘッダーに書き込まれる情報)

接続動作、データの送受信の動作、切断動作などの通信動作全体でどんな情報が必要なのか検討され、その内容、項目がTCPプロトコルの仕様で規定されている。<br>

例:送信元ポート番号、宛先ポート番号、シーケンス番号(送信データの連番)、ACK番号(受信データの連番)<br>

この項目は固定化されており、接続、送受信、切断の格フェーズでクライアントとサーバーがやり取りする都度、この制御情報を付加する<br>
具体的には、クライアントとサーバーがやり取りするパケットの先頭部分に付加するということ。<br>

<パケット全体><br>
[制御情報][データ]<br>

接続動作の段階では、まだデータの送受信は行わないので、パケットの中身は制御情報のみになる。

<パケット全体><br>
[制御情報]<br>

この制御情報のことをパケットの先頭部分に配置することから、「ヘッダー」と呼ぶ。<br>
同じような制御情報はイーサネットやIPにもあり、それも「ヘッダー」と呼ぶので色々なヘッダーが説明で出てくる場合は「TCPヘッダー」「イーサネット・ヘッダー」「IPヘッダー」というように何のヘッダーか分かるようにする。<br>

クライアントとサーバーはこのヘッダーに必要な情報を記載して連絡を取り合いながら通信動作を進めていく。

2. ソケットに記録してプロトコルスタックの動作をコントロールするための制御情報(ソケット(プロトコル・スタックのメモリー領域)に記録される情報)

ソケットにアプリケーション(ブラウザ)から通知された情報、通信相手から受け取った情報、送受信動作の進行状況などが随時記録されていく。<br>
そしてプロトコル・スタックは逐一その情報を参照しながら動く。→ソケットの制御情報はプロトコル・スタックのプログラムと一体化している。<br>

プロトコル・スタックがどのような情報を必要とするかは、プロトコル・スタックの作り方(OS)によって違うが、この情報は通信相手からは見えないし、ルールに従いヘッダーに必要な情報を記載してやり取りすれば、問題なく通信できる。

### 接続動作の実際の動き

