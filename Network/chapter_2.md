# TCP/IP、プロトコルスタックが依頼を受けた際の実際の動き

* プロトコル・スタック... OSに組み込まれたネットワーク制御用ソフトウェア<br>

ブラウザから依頼を受けたプロトコル・スタックが TCPプロトコル を用いてメッセージを送受信する4つのフェーズ

1. ソケットを作成する
2. サーバーに接続する
3. データを送受信する
4. サーバーから切断してソケットを抹消

* LANアダプタ... ネットワーク用のハードウェア

## ソケットを作成する

### プロトコル・スタックの内部構成

データ送受信の依頼のおおまかな階層構造<br>

ネットワーク・アプリケーション(ブラウザ、Webサーバー、メーラー、メールサーバー)... ここから下に向けてデータの送受信などの仕事を依頼する<br>

↓<br>

Socketライブラリ(リゾルバ)... DNSサーバーに問い合わせる動作を実行<br> 

↓<br>

プロトコル・スタック(OS内部)<br>

プロトコル・スタックの上部には、「TCP」というプロトコルを使ってデータを送受信する部分と、「UDP」というプロトコルを使ってデータを送受信する部分があり、この2つがアプリケーションからの依頼を受けて送受信動作を実行する<br>

TCP... ブラウザやメールなどの通常のアプリケーションが送受信する場合に使う<br>
UDP... DNSサーバーへの問い合わせなどで短い制御用のデータを送受信する場合に使う<br>

その下に「IP」というプロトコルを使ってパケット送受信動作をコントロールをする部分がある。<br>

IP... インターネットでデータを運ぶ時は、データを小分けにして パケット という形で運ぶが、そのパケットを通信相手まで運ぶのがIPの主な役割で、IPの中には「ICMP」とか「ARP」というプロトコルを扱う部分がある。<br>

ICMP... パケットを運ぶ時に発生するエラーを通知したり、制御用のメッセージを通知する時に使う<br>
ARP(アープ)... IPアドレスに対応するイーセネットのMACアドレスを調べる時に使う

↓<br>

LANドライバ... LANアダプタのハードウェアをコントロールするもので、下にあるLANアダプタが実際の送受動作、つまりケーブルに対して信号を送受信する動作を実行する<br>

↓<br>

LANアダプタ

### ソケットの実態

ソケットの実態は通信制御用の制御情報または、制御情報を記録したメモリー領域<br>
→プロトコル・スタックは内部に制御情報を記録するメモリー領域を持ち、そこに通信動作を制御するための制御情報を記録する<br>
例:通信相手のIPアドレス、ポート番号、通信動作がどのような進行状態か<br>

プロトコルスタックはこの制御情報(ソケット)を参照しながら、動作する<br>

例:データ送信時に相手側のIPアドレスやポート番号を見て、データを送信する<br>
   データ送信をした後の、返事があるのかや送信動作後の経過時間を見て、送り直しを動作が必要か判断する<br>

### socketを呼び出した時の動き

<TCP担当部分>

ブラウザが「socket」を呼び出してソケットを作るように依頼してきたら、プロトコル・スタックは依頼に従いソケットを1つ作成する。<br>

作成の流れ<br>

1. プロトコル・スタックが最初に行うことは、ソケット1つ分のメモリー領域を確保し、そこに中身に相当する制御情報を記録する<br>
   (この時点では、ソケットは作成直後で、まだ送受信動作が始まっていない初期状態のため、初期状態であることを表す制御情報をメモリーに記録する)<br>
   →これで、ソケットが出来上がったことになる。

2. プロトコル・スタックはそのソケットを示すディスクリプタをブラウザに知らせる。
   →以後ブラウザはプロトコル・スタックにデータの送受信動作を依頼する時に、ディスクリプタを通知する<br>
   (ディスクリプタが分かれば、どのソケットかが分かるので、プロトコル・スタックはそのソケットを見て通信相手の必要な情報が分かる)

## サーバーに接続する
